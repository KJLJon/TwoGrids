/**
 * TwoGrids v0.2
 * Copyright (C) 2012 Jonathan Lietzau
 *
 * MIT License - http://github.com/KJLJon/TwoGrids/license
 */
(function(o){function n(n){function t(){for(var o in r)delete r[o]
r.length=0}function e(n,e){for(0>n&&(n=0);void 0!==r[n]&&e>n;)n++
for(;void 0!==r[e]&&e>n;)e--
if(void 0===r[n]){var m=e-n+1
if(i.optimal>m){var f=Math.round((i.optimal-m)/2)
if(n-=f,e+=f,0>n&&(e-=n,n=0),void 0!==r[n])for(;void 0!==r[n];)n++,e++
else if(void 0!==r[e])for(;void 0!==r[e]&&n>0;)n--,e--}for(;void 0!==r[n]&&e>n;)n++
for(;void 0!==r[e]&&e>n;)e--
null!==s&&clearTimeout(s),s=setTimeout(function(){for(var s=n;e>=s;s++)r[s]||(r[s]=null)
u.notify({from:n,to:e})
var f={from:n,to:e,search:i.search,sort:i.sortColumn,asc:i.sortAsc}
a&&(f.loadColumns=!0),o.post(i.url,o.extend(f,i.params),function(o){var s=o.data.length
if(r.length!=parseInt(o.total)&&(t(),r.length=parseInt(o.total)),s!=m){i.optimal=s
for(var u=n+s-1;e>=u;++u)delete r[u]}for(var u=0;s>u;++u)r[n+u]=o.data[u],r[n+u].index=n+u
a&&(l=o[i.columns],a=!1,d.notify({columns:l})),c.notify({from:n,to:e})},"json").error(function(){i.onError(n,e)})},100)}}var i=o.extend({url:"",optimal:100,search:"",sortColumn:null,sortAsc:!0,columns:"columns",params:{},onError:function(o,n){alert("error loading pages "+o+" to "+n)}},n),r={length:0},a=0!=i.columns,l=null,s=null,u=new Slick.Event,c=new Slick.Event,d=new Slick.Event
return{data:r,columns:l,clear:t,ensureData:e,isDataLoaded:function(o,n){for(var t=o;n>=t;++t)if(void 0==r[t]||null==r[t])return!1
return!0},reloadData:function(o,n){for(var t=o;n>=t;++t)delete r[t]
e(o,n)},reloadColumns:function(){0!=i.columns&&(a=!0)},removeParam:function(o){delete i.params[o]},setParam:function(o,n){i.params[o]=n},setSort:function(o,n){i.sortColumn=o,i.sortAsc=n,t()},setSearch:function(o){i.search=o,t()},onDataLoading:u,onDataLoaded:c,onColumnLoaded:d}}function t(){function o(o){var e=n.getCellFromEvent(o)
e&&n.canCellBeSelected(e.row,e.cell)&&t.notify([new Slick.Range(e.row,0,e.row,n.getColumns().length)])}var n,t=new Slick.Event
return{init:function(t){n=t,n.onClick.subscribe(o)},destroy:function(){n.onClick.unsubscribe(x.handleGridClick)},onSelectedRangesChanged:t}}function e(e,i){var i=o.extend(!0,{ajax:{url:""},grid:{fullWidthRows:!0,enableCellNavigation:!1},onClick:function(){},onRightClick:function(){},onDblClick:function(){},saveColumns:{order:!0,size:!0,url:"",params:{},onSave:function(){}}},i),a=new n(i.ajax),l=!1
a.onDataLoading.subscribe(function(){if(!r){var n=o(e),t=n.position()
r=o("<span class='loading-indicator'><label>Buffering...</label></span>"),r.css({position:"absolute",top:t.top+.5*n.height()-.5*r.height(),left:t.left+.5*n.width()-.5*r.width()}).appendTo(document.body)}r.show()}),a.onDataLoaded.subscribe(function(o,n){for(var t=n.from;n.to>=t;++t)l.invalidateRow(t)
l.updateRowCount(),l.render(),r.fadeOut()}),a.onColumnLoaded.subscribe(function(n,r){l=new Slick.Grid(e,a.data,r.columns,i.grid),l.setSelectionModel(new t),l.onViewportChanged.subscribe(s),l.onSort.subscribe(function(o,n){a.setSort(n.sortCol.field,n.sortAsc),s()})
var u=function(){var n=[]
for(var t in l.getColumns())n.push({field:t.field,width:t.width})
o.post(i.saveColumns.url,o.extend({},i.saveColumns.params,{order:i.saveColumns.order,size:i.saveColumns.size,columns:n}),function(o){i.onSave(o)})}
i.saveColumns.order&&l.onColumnsReordered.subscribe(u),i.saveColumns.size&&l.onColumnsResized.subscribe(u)
var c
l.onClick.subscribe(function(o,n){c?(clearTimeout(c),c=null,i.onDblClick(n)):c=setTimeout(function(){c=null,i.onClick(n)},250)}),l.onContextMenu.subscribe(function(o,n){i.onRightClick(n)}),o(window).resize(function(){l.resizeCanvas()}),l.onViewportChanged.notify()})
var s=function(){var o=l.getViewport()
a.ensureData(o.top,o.bottom)},u=function(){0!=l&&(l.destroy(),a.clear(),a.reloadColumns()),a.ensureData(0,10)}
return u(),{grid:l,model:a,search:function(o){a.setSearch(o),s()},reload:u,destroy:function(){l.destroy(),a.clear()},setParam:function(o,n){a.setParam(o,n)},setView:function(o){a.setParam("view",o),s()}}}function i(n){var t=!1,i=function(o){o=o.row
var n=c.model
n.isDataLoaded(o,o)&&r(n.data[o].id)}
n=o.extend(!0,{url:"",top:"#tg",bottom:"#bg",topView:!1,bottomView:!1,topGrid:{},bottomGrid:{},saveColumns:"",topRightClick:function(){},topDblClick:i,bottomRightClick:function(){},bottomDblClick:function(){}},n)
var r=function(i){if(0!=d)t!=i&&(t=i,d.setParam("id",i),d.reload())
else{t=i
var r={url:n.url,params:{model:"bottom",id:i}},l=o.extend(!0,{},s)
l.model="bottom",0!=a&&(r.params.view=a,l.params.view=a),d=new e(n.bottom,{ajax:r,saveColumns:l,grid:n.bottomGrid,onRightClick:n.bottomRightClick,onDblClick:n.bottomDblClick})}},a=n.bottomView,l={url:n.url,params:{model:"top"}}
0!=n.topView&&(l.params.view=n.topView)
var s=0!=n.saveColumns
s={size:s,order:s,url:n.saveColumns,params:{model:"top"}}
var u=s,c=new e(n.top,{ajax:l,saveColumns:u,grid:n.topGrid,onRightClick:n.topRightClick,onClick:i,onDblClick:n.topDblClick}),d=!1
return{top:c,bottom:d,loadBottomGrid:r,setBottomView:function(o){0!=d&&d.setView(o),a=o},setTopView:function(o){u.params.view=o,c.setView(o)}}}var r=!1
o.extend(!0,window,{Slick:{KJL:{AjaxModel:n,RowSelectionModel:t,SingleGrid:e,TwoGrid:i}}})})(jQuery)